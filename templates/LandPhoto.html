{% extends "base.html" %}
{% block title %}الإشعارات{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-12 col-lg-9">

      <!-- رأس الصفحة -->
      <div class="d-flex align-items-center justify-content-between mb-4">
        <a href="{{ url_for('home') }}" class="btn btn-glass-light rounded-pill px-3">
          <i class="bi bi-house-door me-1"></i> الرئيسية
        </a>

        <div class="d-flex align-items-center gap-2">
          <form action="{{ url_for('notifications_mark_read') }}" method="post" class="m-0">
            <button type="submit"
                    class="btn btn-warning text-dark rounded-pill px-3 d-flex align-items-center gap-2"
                    {% if unread_notifications == 0 %}disabled{% endif %}>
              <i class="bi bi-check2-circle"></i>
              تمييز كمقروء
              {% if unread_notifications and unread_notifications > 0 %}
                <span class="badge bg-dark text-light ms-1">{{ unread_notifications }}</span>
              {% endif %}
            </button>
          </form>
        </div>
      </div>

      <div class="d-flex align-items-center mb-3">
        <h2 class="m-0 fw-bold text-contrast"><i class="bi bi-bell me-2 text-warning"></i> الإشعارات</h2>
      </div>

      {% if notifications and notifications|length %}
        {% for n in notifications %}
          {% set is_like = (n.ntype == 'like') %}
          {% set is_comment = (n.ntype == 'comment') %}
          {% set is_follow = (n.ntype == 'follow') %}

          <!-- بطاقة إشعار زجاجية -->
          <div class="card notif-glass border-0 mb-3 shadow-sm fade-in" id="notif-{{ n.id }}">
            <div class="card-body p-3 p-md-4 d-flex align-items-start gap-3">

              <!-- أيقونة زجاجية -->
              <div class="flex-shrink-0">
                {% if is_comment %}
                  <span class="glass-icon glass-blue"><i class="bi bi-chat-dots-fill"></i></span>
                {% elif is_like %}
                  <span class="glass-icon glass-red"><i class="bi bi-heart-fill"></i></span>
                {% elif is_follow %}
                  <span class="glass-icon glass-green"><i class="bi bi-person-plus-fill"></i></span>
                {% else %}
                  <span class="glass-icon"><i class="bi bi-bell-fill"></i></span>
                {% endif %}
              </div>

              <!-- تفاصيل -->
              <div class="flex-grow-1">
                <div class="fw-semibold text-contrast">
                  {% if n.actor %}
                    <span class="text-warning">{{ n.actor.display_name or n.actor.username }}</span>
                  {% else %}مستخدم{% endif %}

                  {% if is_like %} أعجب بصورتك
                  {% elif is_comment %} علّق على صورتك
                  {% elif is_follow %} بدأ بمتابعتك
                  {% else %} قام بنشاط جديد
                  {% endif %}
                </div>

                <div class="small text-light-70 mt-1">{{ format_time(n.created_at) }}</div>

                <div class="mt-2 d-flex flex-wrap gap-2">
                  {% if n.photo_id %}
                    <a class="btn btn-xs btn-glass-light rounded-pill"
                       href="{{ url_for('home') }}#photo-{{ n.photo_id }}">
                      <i class="bi bi-image me-1"></i> فتح الصورة
                    </a>
                  {% endif %}
                  {% if n.comment_id %}
                    <a class="btn btn-xs btn-glass-light rounded-pill"
                       href="{{ url_for('home') }}#comment-{{ n.comment_id }}">
                      <i class="bi bi-chat-left-text me-1"></i> عرض التعليق
                    </a>
                  {% endif %}
                </div>
              </div>

              <!-- شارة الحالة -->
              <div class="flex-shrink-0">
                {% if n.read %}
                  <span class="badge rounded-pill bg-dark text-light border border-light-subtle">مقروء</span>
                {% else %}
                  <span class="badge rounded-pill bg-warning text-dark">جديد</span>
                {% endif %}
              </div>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="card notif-glass border-0 text-center p-5">
          <div class="display-6 mb-3 text-contrast"><i class="bi bi-bell-slash text-warning"></i></div>
          <h5 class="text-contrast mb-2">لا إشعارات بعد…</h5>
          <p class="text-light-70 mb-4">انشر صورة أو تابع مستخدمين لتظهر إشعاراتك هنا.</p>
          <a href="{{ url_for('upload') }}" class="btn btn-warning text-dark rounded-pill px-4">
            <i class="bi bi-cloud-upload me-1"></i> ارفع صورة
          </a>
        </div>
      {% endif %}

      <div class="text-center mt-5 text-light-60 small">Bootstrap 5 · {{ now.year }} · صنع بحب</div>
    </div>
  </div>
</div>

<!-- أنماط زجاجية -->
<style>
  .text-contrast{color:rgba(255,255,255,.95)}
  .text-light-70{color:rgba(255,255,255,.72)}
  .text-light-60{color:rgba(255,255,255,.60)}

  .btn-glass-light{
    border:1px solid rgba(255,255,255,.18)!important;
    background:rgba(255,255,255,.06)!important;
    color:#fff!important;
    backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
  }
  .btn-xs{padding:.25rem .6rem;font-size:.85rem}

  .notif-glass{
    background:
      radial-gradient(120% 120% at 0% 0%, rgba(255,255,255,.04), rgba(255,255,255,0) 60%),
      linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
    border:1px solid rgba(255,255,255,.12);
    border-radius:1rem;
    backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px);
  }

  .glass-icon{
    width:48px;height:48px;border-radius:50%;
    display:inline-flex;align-items:center;justify-content:center;
    color:#fff;font-size:1.1rem;
    border:1px solid rgba(255,255,255,.25);
    background:rgba(255,255,255,.08);
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.06), 0 8px 22px rgba(0,0,0,.25);
    backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
  }
  .glass-blue{
    background:
      radial-gradient(120% 120% at 30% 20%, rgba(0,180,255,.35), rgba(0,180,255,.10) 70%),
      rgba(255,255,255,.08);
    border-color: rgba(0,180,255,.35);
  }
  .glass-red{
    background:
      radial-gradient(120% 120% at 30% 20%, rgba(255,60,60,.35), rgba(255,60,60,.10) 70%),
      rgba(255,255,255,.08);
    border-color: rgba(255,60,60,.35);
  }
  .glass-green{
    background:
      radial-gradient(120% 120% at 30% 20%, rgba(60,210,120,.35), rgba(60,210,120,.10) 70%),
      rgba(255,255,255,.08);
    border-color: rgba(60,210,120,.35);
  }

  .fade-in{opacity:0;transform:translateY(10px);transition:all .35s ease}
  .fade-in.show{opacity:1;transform:none}
</style>

<script>
  // إظهار تدريجي
  document.addEventListener('DOMContentLoaded', () => {
    const items = document.querySelectorAll('.fade-in');
    const io = new IntersectionObserver((es)=>{
      es.forEach(e=>{
        if(e.isIntersecting){ e.target.classList.add('show'); io.unobserve(e.target); }
      });
    },{threshold:.08});
    items.forEach(i=>io.observe(i));
  });
</script>
{% endblock %}