{% set TITLE = title or "لاند فوتو" %}
<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>{{ TITLE }}</title>

  <!-- Bootstrap RTL 5.3 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&family=Cairo+Play:wght@900&display=swap" rel="stylesheet">

  <!-- Project CSS (الترتيب مهم) -->
  <link href="{{ url_for('static', filename='css/theme.css') }}" rel="stylesheet">
  <link href="{{ url_for('static', filename='css/glass.css') }}" rel="stylesheet">
  <link href="{{ url_for('static', filename='css/landphoto.extras.css') }}?v=2" rel="stylesheet">
  <link href="{{ url_for('static', filename='css/feed.css') }}" rel="stylesheet">
  <link href="{{ url_for('static', filename='css/comments.css') }}" rel="stylesheet">
  <link rel="manifest" href="{{ url_for('static', filename='pwa/manifest.webmanifest') }}">
<meta name="theme-color" content="#0a1320">
<link rel="icon" type="image/png" sizes="192x192" href="{{ url_for('static', filename='pwa/icons/icon-192x192.png') }}">
</head>
<body class="bg-dark-gradient text-light">

  <!-- Navbar ثابت مستقر -->
  <nav class="navbar navbar-expand-lg sticky-top glass-nav py-2">
    <div class="container">

      <!-- الشعار + زر 3 شخطات -->
      <div class="d-flex align-items-center gap-2 order-0">
        <a class="navbar-brand p-0 brand-wrap" href="{{ url_for('home') }}">
          <span class="brand-shell">
            <span class="cam">
              <svg viewBox="0 0 24 24" fill="none" stroke="#ffd54d" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="6" width="18" height="14" rx="2" />
                <path d="M9 6l1.5-2h3L15 6" />
                <circle cx="12" cy="13" r="3.1" />
              </svg>
            </span>
            <span class="brand-badge">
              <svg class="brand-svg" viewBox="0 0 200 30" preserveAspectRatio="xMidYMid meet">
                <defs>
                  <linearGradient id="goldGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%"  stop-color="var(--gold1)"/>
                    <stop offset="45%" stop-color="var(--gold2)"/>
                    <stop offset="90%" stop-color="var(--gold3)"/>
                  </linearGradient>
                </defs>
                <text x="100" y="15">لاند فوتو</text>
              </svg>
            </span>
          </span>
        </a>

        <button id="menuToggle" class="navbar-toggler btn-glass-toggle d-inline-flex align-items-center"
                type="button" data-bs-toggle="collapse" data-bs-target="#nav"
                aria-controls="nav" aria-expanded="false" aria-label="Toggle navigation">
          <i class="bi bi-list fs-3"></i>
        </button>
      </div>

      <!-- القائمة -->
      <div class="collapse navbar-collapse order-1" id="nav">
        <!-- الروابط الرئيسية -->
        <ul class="navbar-nav me-auto gap-lg-2">
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('home') }}">
              <i class="bi bi-house me-1"></i> الرئيسية
            </a>
          </li>

          {% if current_user.is_authenticated %}
            <li class="nav-item"><a class="nav-link" href="{{ url_for('upload') }}"><i class="bi bi-cloud-upload me-1"></i> رفع صورة</a></li>
            <li class="nav-item">
              <a class="nav-link position-relative" href="{{ url_for('notifications_page') }}">
                <i class="bi bi-bell"></i> الإشعارات
                {% if unread_notifications and unread_notifications>0 %}
                  <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-warning text-dark">{{ unread_notifications }}</span>
                {% endif %}
              </a>
            </li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('saved') }}"><i class="bi bi-bookmark-heart me-1"></i> محفوظاتي</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('profile', username=current_user.username) }}"><i class="bi bi-person-badge me-1"></i> ملفي</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('settings') }}"><i class="bi bi-gear me-1"></i> الإعدادات</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('chat_inbox') }}"><i class="bi bi-chat-dots"></i> الرسائل</a></li>
            <li><hr class="glass-divider"></li>
            <li class="nav-item"><a class="nav-link text-danger" href="{{ url_for('auth_logout') }}"><i class="bi bi-box-arrow-right me-1"></i> تسجيل خروج</a></li>
          {% else %}
            <!-- ضيوف: أزرار زجاجية تحت الرئيسية داخل الـ collapse -->
            <li class="nav-item"><a class="nav-glass-btn" href="{{ url_for('auth_login') }}">🔑 دخول</a></li>
            <li class="nav-item"><a class="nav-glass-btn" href="{{ url_for('auth_register') }}">✨ حساب جديد</a></li>
          {% endif %}
        </ul>

        <!-- يمين الناف (فارغ للضيوف) -->
        <ul class="navbar-nav ms-auto align-items-center"></ul>
      </div>
    </div>
  </nav>

  <!-- Flash -->
  <div class="container mt-3">
    {% with messages = get_flashed_messages(with_categories=True) %}
      {% if messages %}
        {% for cat, msg in messages %}
          <div class="alert alert-{{ 'warning' if cat=='message' else cat }} glass border-0 shadow-sm">{{ msg }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}
  </div>

  <!-- Content -->
  <main class="py-4"><div class="container">{% block content %}{% endblock %}</div></main>

  <footer class="py-4 text-center text-secondary small">صنع بحب • Diyar • {{ now.year }}</footer>

  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="{{ url_for('static', filename='js/comments.js') }}" defer></script>
  <script>
    // نبضة وهج لحظة الفتح/الإغلاق فقط
    (function(){
      const toggler = document.getElementById('menuToggle');
      const nav = document.getElementById('nav');
      if(!toggler || !nav) return;
      function pulse(){
        toggler.classList.add('glow-pulse');
        setTimeout(()=>toggler.classList.remove('glow-pulse'), 900);
      }
      nav.addEventListener('show.bs.collapse', pulse);
      nav.addEventListener('hide.bs.collapse', pulse);
    })();
  </script>
  
  <!-- تأكيد زجاجي عام -->
<div class="modal fade" id="confirmModal" tabindex="-1" dir="rtl" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content glass-modal">
      <div class="modal-header border-0">
        <h6 class="modal-title">تأكيد العملية</h6>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="إغلاق"></button>
      </div>
      <div class="modal-body">
        هل تريد المتابعة؟
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-glass" data-bs-dismiss="modal">إلغاء</button>
        <button type="button" class="btn btn-danger" id="confirmOk">حسناً</button>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  let pendingForm = null;
  const modalEl = document.getElementById('confirmModal');
  if(!modalEl) return;
  const modal   = new bootstrap.Modal(modalEl);
  const bodyEl  = modalEl.querySelector('.modal-body');
  const okBtn   = modalEl.querySelector('#confirmOk');

  document.addEventListener('click', function(e){
    const btn = e.target.closest('.js-confirm');
    if(!btn) return;
    e.preventDefault();
    const form = btn.closest('form');
    if(!form) return;
    pendingForm = form;
    const txt = btn.dataset.confirmText || 'هل تريد المتابعة؟';
    bodyEl.textContent = txt;
    modal.show();
  }, true);

  okBtn.addEventListener('click', function(){
    if(pendingForm){
      modal.hide();
      // أمان بسيط لتجنّب تعدد النقرات
      setTimeout(()=> pendingForm.submit(), 10);
      pendingForm = null;
    }
  });
})();
</script>
</body>
</html>